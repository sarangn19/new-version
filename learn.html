<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aspirant Dashboard (Sidebar + Search)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="js/profile-manager.js"></script>
  <script src="js/study-tools.js"></script>
  <script src="js/performance-optimizer.js"></script>
  <script src="js/loading-state-manager.js"></script>
  <script src="js/error-handler.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="styles/glassmorphism.css" rel="stylesheet">
  <link href="styles/theme-system.css" rel="stylesheet">
  <link href="styles/accessibility.css" rel="stylesheet">
  <link href="styles/unified-theme.css" rel="stylesheet">

  <style>
    :root {
      --bg-dark-1: #1F1F1F;
      --bg-dark-2: #1A1A1A;
      --teal-primary: #2C7A7B;
      --text-faded: rgba(255, 255, 255, 0.5);
      --search-bg-glass: rgba(255, 255, 255, 0.02);
      --search-border-glass: rgba(255, 255, 255, 0.05);
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-dark-1);
      color: white;
    }

    .scroll-hidden::-webkit-scrollbar { display: none; }
    .scroll-hidden { -ms-overflow-style: none; scrollbar-width: none; }

    /* Glass Searchbar */
    .glass-search-container {
      background-color: var(--search-bg-glass);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid var(--search-border-glass);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .arrow-circle-button {
      width: 44px;
      height: 44px;
      background-color: var(--bg-dark-1);
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .arrow-circle-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    /* --- GLASSMORPHISM EFFECTS --- */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    .glass-sidebar {
      background: rgba(26, 26, 26, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- SMOOTH ANIMATIONS --- */
    .page-transition {
      animation: fadeInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .nav-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .nav-item:hover::before {
      left: 100%;
    }

    .nav-item:hover {
      transform: translateX(4px);
      background: rgba(42, 42, 42, 0.8);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(44, 122, 123, 0.2), rgba(42, 42, 42, 0.9));
      border-left: 3px solid var(--teal-primary);
    }
  </style>
</head>
<body class="min-h-screen text-white antialiased scroll-hidden" data-theme="dark" data-color-scheme="default" data-dashboard-layout="compact">

  <div class="flex flex-col lg:flex-row h-screen bg-[var(--bg-dark-1)]">
    
    <!-- SIDEBAR -->
    <aside id="sidebar" class="hidden lg:flex flex-col w-[280px] glass-sidebar p-8 pt-20 flex-shrink-0 overflow-y-auto scroll-hidden">
      <!-- Profile and Notifications -->
      <div class="flex items-center justify-between px-2 mb-10">
        <div class="flex items-center space-x-4"> 
          <div class="relative">
            <a href="profile.html" class="user-avatar block w-12 h-12 rounded-full overflow-hidden bg-[#84D0F7] border-2 border-white/50 flex items-center justify-center hover:scale-105 transition-transform duration-200 cursor-pointer">
              <div id="user-initials" class="user-initials text-lg font-medium text-black">U</div>
            </a>
            <!-- Notification badge -->
            <button id="notification-btn" aria-label="Notifications" class="absolute -right-2 -top-2 w-8 h-8 bg-[var(--bg-dark-1)]/90 backdrop-blur-sm rounded-full flex items-center justify-center border border-white/10 shadow-sm hover:bg-gray-700">
              <span class="w-6 h-6 rounded-full bg-[#111111] flex items-center justify-center">
                <i data-lucide="bell" class="text-white w-4 h-4"></i>
              </span>
            </button>
          </div>
          <div>
            <div id="user-name" class="font-normal text-sm">User</div>
            <div id="user-email" class="font-light text-xs opacity-70">user@upsc.com</div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="space-y-1.5 pt-10">
        <a href="db.html" class="nav-item flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <i data-lucide="layout-dashboard" class="text-white opacity-50 w-5 h-5"></i>
          <span class="font-normal text-sm text-white opacity-50">Dashboard</span>
        </a>
        <a href="learn.html" class="nav-item active flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <i data-lucide="book-open" class="text-white w-5 h-5"></i>
          <span class="font-normal text-sm">Learn</span>
        </a>
        <a href="statistics.html" class="nav-item flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <i data-lucide="bar-chart-2" class="text-white opacity-50 w-5 h-5"></i>
          <span class="font-normal text-sm text-white opacity-50">Statistics</span>
        </a>
        <a href="news.html" class="nav-item flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <i data-lucide="newspaper" class="text-white opacity-50 w-5 h-5"></i>
          <span class="font-normal text-sm text-white opacity-50">News</span>
        </a>
        <a href="community.html" class="nav-item flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <i data-lucide="users" class="text-white opacity-50 w-5 h-5"></i>
          <span class="font-normal text-sm text-white opacity-50">Community</span>
        </a>
        <a href="chatbot.html" class="nav-item flex items-center space-x-5 px-8 py-2.5 rounded-full">
          <div class="w-6 h-6 bg-[#84D0F7] rounded-full flex items-center justify-center text-xs font-medium text-black">AI</div>
          <span class="font-normal text-sm text-white opacity-50">AI Assistant</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN CONTENT AREA (Only Searchbar) -->
    <main id="main-content" role="main" tabindex="-1" class="flex-1 p-6 lg:p-8 overflow-y-auto scroll-hidden page-transition">
      <!-- Search Bar -->
      <form onsubmit="event.preventDefault()" 
        class="glass-search-container flex items-center rounded-[2.5rem] p-1.5 mb-6 w-full max-w-7xl mx-auto">
        <i data-lucide="search" class="search-icon text-white/70 w-5 h-5 mx-4 flex-shrink-0 transition-colors duration-300"></i> 
        <input
          type="text"
          id="search-input"
          aria-label="Search notes, flashcards, MCQs"
          placeholder="Search notes, flashcards, MCQs..."
          class="bg-transparent text-white placeholder-[var(--text-faded)] text-sm font-normal flex-grow focus:outline-none py-2"
          autocomplete="off"
        />
        <div class="arrow-circle-button" onclick="handleSearch(event)">
          <i data-lucide="arrow-right" class="text-white w-5 h-5"></i>
        </div>
      </form>

      <!-- Cards Section -->
      <div class="max-w-5xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Notes Card -->
          <a href="notes.html" class="bg-[#2A2A2A] rounded-2xl p-6 hover:bg-[#333333] transition-all duration-300 cursor-pointer group relative overflow-hidden block">
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                <i data-lucide="arrow-right" class="text-white/70 w-4 h-4"></i>
              </div>
            </div>
            <div class="w-12 h-12 rounded-xl bg-[#84D0F7]/10 flex items-center justify-center mb-4">
              <i data-lucide="file-text" class="text-[#84D0F7] w-6 h-6"></i>
            </div>
            <h3 class="text-xl font-medium mb-2">Notes</h3>
            <p class="text-sm text-white/60 mb-8">Create and organize your study notes with rich text formatting.</p>
            <div class="absolute bottom-4 left-6 right-6">
              <div class="flex items-center text-xs text-white/40">
                <i data-lucide="file-text" class="w-3.5 h-3.5 mr-1.5"></i>
                <span id="notes-count">0 notes</span>
              </div>
            </div>
          </a>

          <!-- MCQs Card -->
          <a href="mcq.html" class="bg-[#2A2A2A] rounded-2xl p-6 hover:bg-[#333333] transition-all duration-300 cursor-pointer group relative overflow-hidden block">
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                <i data-lucide="arrow-right" class="text-white/70 w-4 h-4"></i>
              </div>
            </div>
            <div class="w-12 h-12 rounded-xl bg-[#F7B84B]/10 flex items-center justify-center mb-4">
              <i data-lucide="list-checks" class="text-[#F7B84B] w-6 h-6"></i>
            </div>
            <h3 class="text-xl font-medium mb-2">MCQs</h3>
            <p class="text-sm text-white/60 mb-8">Practice multiple choice questions with instant feedback.</p>
            <div class="absolute bottom-4 left-6 right-6">
              <div class="flex items-center text-xs text-white/40">
                <i data-lucide="list-checks" class="w-3.5 h-3.5 mr-1.5"></i>
                <span id="mcq-count">0 questions</span>
              </div>
            </div>
          </a>

          <!-- Flashcards Card -->
          <a href="flashcards.html" class="bg-[#2A2A2A] rounded-2xl p-6 hover:bg-[#333333] transition-all duration-300 cursor-pointer group relative overflow-hidden block">
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                <i data-lucide="arrow-right" class="text-white/70 w-4 h-4"></i>
              </div>
            </div>
            <div class="w-12 h-12 rounded-xl bg-[#F87171]/10 flex items-center justify-center mb-4">
              <i data-lucide="layers" class="text-[#F87171] w-6 h-6"></i>
            </div>
            <h3 class="text-xl font-medium mb-2">Flashcards</h3>
            <p class="text-sm text-white/60 mb-8">Create and review flashcards for effective memorization.</p>
            <div class="absolute bottom-4 left-6 right-6">
              <div class="flex items-center text-xs text-white/40">
                <i data-lucide="layers" class="w-3.5 h-3.5 mr-1.5"></i>
                <span id="flashcards-count">0 cards</span>
              </div>
            </div>
          </a>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Initialize enhanced profile manager for cross-page synchronization
    if (typeof ProfileManager !== 'undefined') {
      window.profileManager = new ProfileManager();
      
      // Apply theme preferences
      const preferences = window.profileManager.getPreferences();
      if (preferences) {
        document.documentElement.setAttribute('data-theme', preferences.theme?.mode || 'dark');
        document.documentElement.setAttribute('data-color-scheme', preferences.theme?.colorScheme || 'default');
        document.documentElement.setAttribute('data-dashboard-layout', preferences.dashboard?.layout || 'compact');
        
        if (preferences.accessibility?.reducedMotion) {
          document.documentElement.classList.add('reduced-motion');
        }
        if (preferences.accessibility?.highContrast) {
          document.documentElement.classList.add('high-contrast');
        }
        if (preferences.accessibility?.keyboardNavigation) {
          document.documentElement.classList.add('keyboard-navigation');
        }
      }
    }
    
    // Initialize study tools
    if (typeof PomodoroTimer !== 'undefined') {
      window.pomodoroTimer = new PomodoroTimer();
    }
    
    // Initialize performance optimizer
    if (typeof PerformanceOptimizer !== 'undefined') {
      window.performanceOptimizer = new PerformanceOptimizer();
    }
    
    // Initialize loading state manager
    if (typeof LoadingStateManager !== 'undefined') {
      window.loadingStateManager = new LoadingStateManager();
    }
    
    // Initialize error handler
    if (typeof ErrorHandler !== 'undefined') {
      window.errorHandler = new ErrorHandler();
    }
    
    // Load saved profile picture
    const savedDP = localStorage.getItem('selectedDP');
    const userInitialsEl = document.getElementById('user-initials');
    
    if (savedDP && userInitialsEl) {
      const parentDiv = userInitialsEl.parentElement;
      parentDiv.innerHTML = `<img src="image/${savedDP}.png" alt="Profile Picture" class="w-full h-full object-cover">`;
    }
    
    // Load and display content counts from Firebase and localStorage
    async function loadContentCounts() {
      try {
        let notesCount = 0;
        let flashcardsCount = 0;
        let mcqsCount = 0;
        
        // Try to get from Firebase first
        if (window.firebaseManager?.isReady()) {
          try {
            const [notes, flashcards, mcqs] = await Promise.all([
              window.firebaseManager.getNotes(1000),
              window.firebaseManager.getFlashcards ? window.firebaseManager.getFlashcards(1000) : [],
              window.firebaseManager.getMCQs ? window.firebaseManager.getMCQs(1000) : []
            ]);
            
            notesCount = notes.length;
            flashcardsCount = flashcards.length;
            mcqsCount = mcqs.length;
            
            console.log('ðŸ“Š Content counts loaded from Firebase:', { notes: notesCount, flashcards: flashcardsCount, mcqs: mcqsCount });
          } catch (firebaseError) {
            console.warn('Firebase count fetch failed, using localStorage:', firebaseError);
          }
        }
        
        // Fallback to localStorage if Firebase failed or returned 0
        if (notesCount === 0 && flashcardsCount === 0 && mcqsCount === 0) {
          const localNotes = JSON.parse(localStorage.getItem('userNotes') || '[]');
          const localFlashcards = JSON.parse(localStorage.getItem('flashcards') || '[]');
          const localMCQs = JSON.parse(localStorage.getItem('mcqs') || '[]');
          const localBookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
          
          notesCount = localNotes.length;
          
          // Check both dedicated flashcards storage and bookmarks
          flashcardsCount = localFlashcards.length + localBookmarks.filter(b => b.metadata?.type === 'flashcard').length;
          
          // Check both dedicated MCQs storage and bookmarks  
          mcqsCount = localMCQs.length + localBookmarks.filter(b => b.metadata?.type === 'mcq').length;
          
          console.log('ðŸ“Š Content counts loaded from localStorage:', { 
            notes: notesCount, 
            flashcards: flashcardsCount, 
            mcqs: mcqsCount,
            sources: {
              userNotes: localNotes.length,
              flashcards: localFlashcards.length,
              mcqs: localMCQs.length,
              bookmarkFlashcards: localBookmarks.filter(b => b.metadata?.type === 'flashcard').length,
              bookmarkMCQs: localBookmarks.filter(b => b.metadata?.type === 'mcq').length
            }
          });
        }
        
        // Update display
        const notesCountEl = document.getElementById('notes-count');
        if (notesCountEl) {
          notesCountEl.textContent = `${notesCount} note${notesCount !== 1 ? 's' : ''}`;
        }
        
        const flashcardsCountEl = document.getElementById('flashcards-count');
        if (flashcardsCountEl) {
          flashcardsCountEl.textContent = `${flashcardsCount} card${flashcardsCount !== 1 ? 's' : ''}`;
        }
        
        const mcqCountEl = document.getElementById('mcq-count');
        if (mcqCountEl) {
          mcqCountEl.textContent = `${mcqsCount} question${mcqsCount !== 1 ? 's' : ''}`;
        }
        
      } catch (error) {
        console.error('Error loading content counts:', error);
      }
    }

    // Listen for count updates from other pages (like chatbot)
    window.addEventListener('updateCount', (event) => {
      const { type, count } = event.detail;
      const countEl = document.getElementById(`${type}-count`);
      if (countEl) {
        const label = type === 'notes' ? 'note' : type === 'flashcards' ? 'card' : 'question';
        countEl.textContent = `${count} ${label}${count !== 1 ? 's' : ''}`;
      }
    });

    // Listen for batch count updates from chatbot
    window.addEventListener('contentCountsUpdated', (event) => {
      const counts = event.detail;
      console.log('ðŸ”„ Received batch count update:', counts);
      
      if (counts.notes !== undefined) {
        const notesCountEl = document.getElementById('notes-count');
        if (notesCountEl) {
          notesCountEl.textContent = `${counts.notes} note${counts.notes !== 1 ? 's' : ''}`;
        }
      }
      
      if (counts.flashcards !== undefined) {
        const flashcardsCountEl = document.getElementById('flashcards-count');
        if (flashcardsCountEl) {
          flashcardsCountEl.textContent = `${counts.flashcards} card${counts.flashcards !== 1 ? 's' : ''}`;
        }
      }
      
      if (counts.mcqs !== undefined) {
        const mcqCountEl = document.getElementById('mcq-count');
        if (mcqCountEl) {
          mcqCountEl.textContent = `${counts.mcqs} question${counts.mcqs !== 1 ? 's' : ''}`;
        }
      }
    });

    // Load counts on page load
    loadContentCounts();

    // Refresh counts when page becomes visible (in case content was added in another tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        loadContentCounts();
      }
    });
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    if (window.iconManager) window.iconManager.refresh();
  </script>
</body>
</html>
