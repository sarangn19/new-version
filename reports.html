<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Reports - UPSC Prep</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="js/profile-manager.js"></script>
    <script src="js/report-generator.js"></script>
    <script src="js/performance-analyzer.js"></script>
    <script src="js/data-exporter.js"></script>
    <script src="js/loading-state-manager.js"></script>
    <script src="js/error-handler.js"></script>
    <link rel="stylesheet" href="styles/glassmorphism.css">
    <link rel="stylesheet" href="styles/theme-system.css">
    <link href="styles/accessibility.css" rel="stylesheet">
    <link href="styles/unified-theme.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .reports-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .nav-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            color: white;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .report-card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #3b82f6;
        }

        .report-card p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .report-card .btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .report-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .report-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 30px;
            display: none;
        }

        .report-display.active {
            display: block;
        }

        .report-content {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .recommendation-card {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .recommendation-card.critical {
            background: #fff5f5;
            border-left: 4px solid #ef4444;
        }

        .recommendation-card.important {
            background: #fffbf0;
            border-left: 4px solid #f59e0b;
        }

        .recommendation-card.suggested {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .export-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .export-btn.html {
            background: #3b82f6;
            color: white;
        }

        .export-btn.json {
            background: #10b981;
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <div class="header">
            <h1>üìä Study Reports</h1>
            <p>Generate comprehensive reports to track your learning progress</p>
        </div>

        <div class="nav-buttons">
            <a href="analytics.html" class="nav-btn">‚Üê Back to Analytics</a>
            <a href="profile.html" class="nav-btn">Profile</a>
            <a href="learn.html" class="nav-btn">Dashboard</a>
        </div>

        <div class="report-options">
            <div class="report-card">
                <h3>üìÖ Weekly Report</h3>
                <p>Get insights into your past week's study performance, including accuracy trends, study time, and personalized recommendations.</p>
                <button class="btn" onclick="generateWeeklyReport()">Generate Weekly Report</button>
            </div>

            <div class="report-card">
                <h3>üìà Monthly Report</h3>
                <p>Comprehensive monthly analysis with comparative insights, detailed trends, and long-term progress tracking.</p>
                <button class="btn" onclick="generateMonthlyReport()">Generate Monthly Report</button>
            </div>

            <div class="report-card">
                <h3>üéØ Subject Report</h3>
                <p>Focus on specific subjects to identify strengths and weaknesses in different areas of your preparation.</p>
                <select id="subjectSelect" style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">All Subjects</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Science">Science</option>
                    <option value="History">History</option>
                    <option value="Geography">Geography</option>
                    <option value="Polity">Polity</option>
                    <option value="Economics">Economics</option>
                    <option value="Environment">Environment</option>
                </select>
                <button class="btn" onclick="generateSubjectReport()">Generate Subject Report</button>
            </div>
        </div>

        <div id="reportDisplay" class="report-display">
            <div id="reportContent" class="report-content">
                <!-- Report content will be inserted here -->
            </div>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Generating your report...</p>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="js/profile-manager.js"></script>
    <script src="js/performance-analyzer.js"></script>
    <script src="js/report-generator.js"></script>

    <script>
        let currentReport = null;

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('reportDisplay').classList.remove('active');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div class="error-message">
                    <h3>‚ùå Error Generating Report</h3>
                    <p>${message}</p>
                    <p>Please try refreshing the page or contact support if the issue persists.</p>
                </div>
            `;
            document.getElementById('reportDisplay').classList.add('active');
        }

        function generateSampleDataIfNeeded() {
            // No sample data generation - use actual user data only
            return false;
        }
            
            // Generate 30 days of realistic data
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // Generate 1-3 sessions per day
                const sessionsPerDay = Math.floor(Math.random() * 3) + 1;
                
                for (let j = 0; j < sessionsPerDay; j++) {
                    sessions.push({
                        date: new Date(date.getTime() + j * 3600000),
                        duration: Math.random() * 3600 + 1800, // 30-90 minutes
                        type: ['mcq', 'flashcard', 'notes'][Math.floor(Math.random() * 3)],
                        subject: ['Mathematics', 'Science', 'History', 'Geography', 'Polity', 'Economics'][Math.floor(Math.random() * 6)],
                        chapter: `Chapter ${Math.floor(Math.random() * 10) + 1}`,
                        questionsAttempted: Math.floor(Math.random() * 50) + 10,
                        correctAnswers: Math.floor(Math.random() * 40) + 5,
                        accuracy: Math.random() * 40 + 60, // 60-100%
                        averageResponseTime: Math.random() * 30 + 10,
                        focusQuality: Math.random() * 30 + 70,
                        completionRate: Math.random() * 20 + 80
                    });
                }
                
                // Generate assessments (less frequent)
                if (Math.random() > 0.6) {
                    assessments.push({
                        date: date,
                        type: ['practice', 'mock', 'quiz'][Math.floor(Math.random() * 3)],
                        subject: ['Mathematics', 'Science', 'History', 'Geography', 'Polity', 'Economics'][Math.floor(Math.random() * 6)],
                        totalQuestions: Math.floor(Math.random() * 50) + 20,
                        correctAnswers: Math.floor(Math.random() * 40) + 10,
                        accuracy: Math.random() * 40 + 60,
                        timeSpent: Math.random() * 3600 + 1200,
                        difficulty: ['easy', 'medium', 'hard'][Math.floor(Math.random() * 3)],
                        score: Math.floor(Math.random() * 40) + 60,
                        maxScore: 100
                    });
                }
            }
            
            // Record the data
            sessions.forEach(session => {
                window.performanceAnalyzer.recordSession(session);
            });
            
            assessments.forEach(assessment => {
                window.performanceAnalyzer.recordAssessment(assessment);
            });
        }

        function generateWeeklyReport() {
            showLoading();
            
            try {
                if (!window.reportGenerator) {
                    throw new Error('Report generator not available. Please refresh the page.');
                }

                const sampleDataGenerated = generateSampleDataIfNeeded();
                
                setTimeout(() => {
                    try {
                        const report = window.reportGenerator.generateReport('weekly');
                        currentReport = report;
                        displayReport(report, 'Weekly Study Report', sampleDataGenerated);
                    } catch (error) {
                        showError(`Failed to generate weekly report: ${error.message}`);
                    }
                }, 1000);
                
            } catch (error) {
                showError(`Error generating weekly report: ${error.message}`);
            }
        }

        function generateMonthlyReport() {
            showLoading();
            
            try {
                if (!window.reportGenerator) {
                    throw new Error('Report generator not available. Please refresh the page.');
                }

                const sampleDataGenerated = generateSampleDataIfNeeded();
                
                setTimeout(() => {
                    try {
                        const report = window.reportGenerator.generateReport('monthly');
                        currentReport = report;
                        displayReport(report, 'Monthly Study Report', sampleDataGenerated);
                    } catch (error) {
                        showError(`Failed to generate monthly report: ${error.message}`);
                    }
                }, 1500);
                
            } catch (error) {
                showError(`Error generating monthly report: ${error.message}`);
            }
        }

        function generateSubjectReport() {
            const subject = document.getElementById('subjectSelect').value;
            const reportType = subject ? 'weekly' : 'weekly'; // Default to weekly for subject reports
            
            showLoading();
            
            try {
                if (!window.reportGenerator) {
                    throw new Error('Report generator not available. Please refresh the page.');
                }

                const sampleDataGenerated = generateSampleDataIfNeeded();
                
                setTimeout(() => {
                    try {
                        const report = window.reportGenerator.generateReport(reportType, subject || null);
                        currentReport = report;
                        const title = subject ? `${subject} Subject Report` : 'All Subjects Report';
                        displayReport(report, title, sampleDataGenerated);
                    } catch (error) {
                        showError(`Failed to generate subject report: ${error.message}`);
                    }
                }, 1000);
                
            } catch (error) {
                showError(`Error generating subject report: ${error.message}`);
            }
        }

        function displayReport(report, title, sampleDataGenerated = false) {
            hideLoading();
            
            const reportContent = document.getElementById('reportContent');
            
            // No sample data notices needed
            
            const html = `

                <h2>${title}</h2>
                <p><strong>Period:</strong> ${report.metadata.period.formatted}</p>
                <p><strong>Generated:</strong> ${report.metadata.generatedAt.toLocaleString()}</p>
                
                <h3>üìà Performance Overview</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #3b82f6;">
                            ${report.sections.overview.summary.performanceScore.formatted}
                        </div>
                        <div class="metric-label">Performance Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #10b981;">
                            ${report.sections.overview.summary.overallAccuracy.formatted}
                        </div>
                        <div class="metric-label">Overall Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #f59e0b;">
                            ${report.sections.overview.summary.totalStudyTime.formatted}
                        </div>
                        <div class="metric-label">Study Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #8b5cf6;">
                            ${report.sections.overview.summary.sessionsCompleted.formatted}
                        </div>
                        <div class="metric-label">Sessions Completed</div>
                    </div>
                </div>
                
                <h3>üéØ Key Insights</h3>
                <ul class="insights-list">
                    ${report.sections.overview.highlights.map(highlight => 
                        `<li style="border-left-color: ${highlight.type === 'success' ? '#10b981' : '#3b82f6'};">
                            ${highlight.message}
                        </li>`
                    ).join('')}
                </ul>
                
                <h3>üìä Performance Analysis</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: ${report.sections.performance.keyMetrics.accuracy.status === 'good' ? '#10b981' : '#ef4444'};">
                            ${report.sections.performance.keyMetrics.accuracy.current.toFixed(1)}%
                        </div>
                        <div class="metric-label">Accuracy (Target: ${report.sections.performance.keyMetrics.accuracy.benchmark}%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: ${report.sections.performance.keyMetrics.consistency.status === 'good' ? '#10b981' : '#ef4444'};">
                            ${report.sections.performance.keyMetrics.consistency.current.toFixed(1)}%
                        </div>
                        <div class="metric-label">Consistency (Target: ${report.sections.performance.keyMetrics.consistency.benchmark}%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: ${report.sections.performance.keyMetrics.focusQuality.status === 'good' ? '#10b981' : '#ef4444'};">
                            ${report.sections.performance.keyMetrics.focusQuality.current.toFixed(1)}%
                        </div>
                        <div class="metric-label">Focus Quality (Target: ${report.sections.performance.keyMetrics.focusQuality.benchmark}%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #6366f1;">
                            ${report.sections.performance.keyMetrics.responseSpeed.current.toFixed(1)}
                        </div>
                        <div class="metric-label">Response Speed (${report.sections.performance.keyMetrics.responseSpeed.unit})</div>
                    </div>
                </div>
                
                <h3>üí™ Strengths</h3>
                <ul class="insights-list">
                    ${report.sections.performance.strengths.map(strength => 
                        `<li style="border-left-color: #10b981;">
                            <strong>${strength.area}:</strong> ${strength.description} (Score: ${strength.score.toFixed(1)})
                        </li>`
                    ).join('')}
                </ul>
                
                <h3>üéØ Areas for Improvement</h3>
                <ul class="insights-list">
                    ${report.sections.performance.weaknesses.map(weakness => 
                        `<li style="border-left-color: #ef4444;">
                            <strong>${weakness.area}:</strong> ${weakness.description} (Score: ${weakness.score.toFixed(1)})
                            ${weakness.suggestion ? `<br><em>Suggestion: ${weakness.suggestion}</em>` : ''}
                        </li>`
                    ).join('')}
                </ul>
                
                <h3>üí° Recommendations</h3>
                <div class="recommendations-grid">
                    ${report.recommendations.critical.map(rec => 
                        `<div class="recommendation-card critical">
                            <strong>üî¥ Critical:</strong> ${rec.suggestion}<br>
                            <small><strong>Action:</strong> ${rec.action}</small>
                        </div>`
                    ).join('')}
                    ${report.recommendations.important.map(rec => 
                        `<div class="recommendation-card important">
                            <strong>üü° Important:</strong> ${rec.suggestion}<br>
                            <small><strong>Action:</strong> ${rec.action}</small>
                        </div>`
                    ).join('')}
                    ${report.recommendations.suggested.map(rec => 
                        `<div class="recommendation-card suggested">
                            <strong>üü¢ Suggested:</strong> ${rec.suggestion}<br>
                            <small><strong>Action:</strong> ${rec.action}</small>
                        </div>`
                    ).join('')}
                </div>
                
                <div class="export-buttons">
                    <button class="export-btn html" onclick="exportReport('html')">üìÑ Export as HTML</button>
                    <button class="export-btn json" onclick="exportReport('json')">üìã Export as JSON</button>
                </div>
            `;
            
            reportContent.innerHTML = html;
            document.getElementById('reportDisplay').classList.add('active');
        }

        function exportReport(format) {
            if (!currentReport) {
                alert('No report available to export. Please generate a report first.');
                return;
            }
            
            try {
                const content = window.reportGenerator.exportReport(currentReport, format);
                const filename = `${currentReport.metadata.type}_report_${new Date().toISOString().split('T')[0]}.${format}`;
                const mimeType = format === 'html' ? 'text/html' : 'application/json';
                
                downloadFile(content, filename, mimeType);
            } catch (error) {
                alert(`Error exporting report: ${error.message}`);
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize enhanced profile manager for cross-page synchronization
            if (typeof ProfileManager !== 'undefined') {
              window.profileManager = new ProfileManager();
              
              // Apply theme preferences
              const preferences = window.profileManager.getPreferences();
              if (preferences) {
                document.documentElement.setAttribute('data-theme', preferences.theme?.mode || 'dark');
                document.documentElement.setAttribute('data-color-scheme', preferences.theme?.colorScheme || 'default');
                
                if (preferences.accessibility?.reducedMotion) {
                  document.documentElement.classList.add('reduced-motion');
                }
                if (preferences.accessibility?.highContrast) {
                  document.documentElement.classList.add('high-contrast');
                }
                if (preferences.accessibility?.keyboardNavigation) {
                  document.documentElement.classList.add('keyboard-navigation');
                }
              }
            }
            
            // Initialize report components
            if (typeof ReportGenerator !== 'undefined') {
              window.reportGenerator = new ReportGenerator();
            }
            
            if (typeof PerformanceAnalyzer !== 'undefined') {
              window.performanceAnalyzer = new PerformanceAnalyzer();
            }
            
            if (typeof DataExporter !== 'undefined') {
              window.dataExporter = new DataExporter();
            }
            
            // Initialize loading state manager
            if (typeof LoadingStateManager !== 'undefined') {
              window.loadingStateManager = new LoadingStateManager();
            }
            
            // Initialize error handler
            if (typeof ErrorHandler !== 'undefined') {
              window.errorHandler = new ErrorHandler();
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            
            // Check if required components are loaded
            if (!window.reportGenerator) {
                showError('Report generator not loaded. Please refresh the page.');
                return;
            }
            
            if (!window.performanceAnalyzer) {
                showError('Performance analyzer not loaded. Please refresh the page.');
                return;
            }
            
            console.log('Reports page initialized successfully');
        });
    </script>
</body>
</html>